<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <?define deltashell_gui_bin="$(var.SolutionDir)\src\DeltaShell\DeltaShell.Gui\bin\"?>
  
  <?define ReleaseVersion="1.0.0" ?>
  <?define ShortVersion="1.0" ?>
  <?define ProductName="XBeach-G (Early Preview)" ?>
  <?ifdef env.BUILD_NUMBER ?>
    <?define FullProductVersion="$(var.ReleaseVersion).$(env.BUILD_NUMBER)" ?>
  <?else?>
    <?define FullProductVersion="$(var.ReleaseVersion).0" ?>
  <?endif?>

  <?define Title="XBeach-G (Early Preview)" ?>
  <?define Description="Storm impact model for gravel beaches" ?>
  <?define ManualFileName="XBeach-G GUI User Manual 1.0.0.pdf"?>
  <?define SplashScreen="xbeachg_splash.bmp"?>
  <?define StartPageHtmlName="StartPage.htm"?>


  <!-- Do not change this value, unless you want to remove the possibility of the 
         current installer to not (be able to) upgrade/patch an older installation. -->
  <?define UpgradeCode="91E192F6-9878-4FCC-A2C5-4D6CA889B0AC" ?>

  <Product Name="$(var.ProductName) $(var.FullProductVersion)" Id="*" UpgradeCode="$(var.UpgradeCode)"
    Language="1033" Codepage="1252" Version="$(var.FullProductVersion)" Manufacturer="Deltares">
    
    <Package Id="*" Keywords="Installer" Description="$(var.ProductName) Installer"
      Comments="$(var.ProductName) is a program developed by Deltares." Manufacturer="Deltares"
      InstallerVersion="100" Languages="1033" Compressed="yes" SummaryCodepage="1252" />

    <!-- The following piece of code is responsible for enabling "Mayor Upgrades".
         It allows for patching an existing installations and incremental upgrades
         such a going from an existing 3.1 installation to 3.2 with an incremental
         installer.
         This is currently commented out as this feature is not used properly nor is
         it currently wanted. In order to allow mayor patches and mayor upgrades, the 
         Product.UpgradeCode between installs should be identical, the Product.ID 
         should be different and the Product.Version should be different. Next,
         the current Product.Version should be within the range of the (previous?)
         installation specified below, in order to recognize an upgrade. If that value
         falls outside the area, the installations are considered completely unrelated.
         
         For more info, check:
         http://blogs.technet.com/b/alexshev/archive/2008/02/15/from-msi-to-wix-part-8-major-upgrade.aspx
         and
         http://msdn.microsoft.com/en-us/library/aa369786(v=vs.85).aspx
         [bouvrie]
        
        <Upgrade Id="$(var.UpgradeCode)">
          <UpgradeVersion OnlyDetect="no" Property="PREVIOUSFOUND"
            Minimum="1.0.0.0" IncludeMinimum="yes" 
            Maximum="1.99.0.0" IncludeMaximum="no" />
        </Upgrade>
        -->

     <!--check for dotnet version--> 
    <?include ..\..\DeltaShell\DotNetFramework4Check.wxi?>
     <!--check for version of operating system--> 
    <?include ..\..\DeltaShell\OSVersionCheck.wxi?>

    <Property Id="INSTALLDIR">
      <RegistrySearch Id="DeltaresDeltaShellRegistry" Type="raw"
        Root="HKLM" Key="Software\[Manufacturer]\[ProductName]" Name="InstallDir" />
    </Property>

    <Media Id="1" Cabinet="Sample.cab" EmbedCab="yes" />

    <Icon Id="icon.ico" SourceFile="Resources\XBeachG.ico"/>
    <Icon Id="pdf.ico" SourceFile="Resources\pdf.ico"/>

    <!-- uninstall group shows specific icon-->
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />

    <!--define a directory structure for main application and plugins -->
    <!-- use include files to tell the installer which files should be copied to target directories -->
    <Directory Id="TARGETDIR" Name="SourceDir">

      <!-- This line should be included due to installer's payload is dependent on the 
             Visual Studio C++ redistributable. It should always be directly under TARGETDIR.
          
             For more info, check:
             http://wixtoolset.org/documentation/manual/v3/howtos/redistributables_and_install_checks/install_vcredist.html
        -->
      <Merge Id="VCRedis10" Language="0" SourceFile="Dependencies\microsoft_vc100_crt_x86.msm" DiskId="1" />

      <!--Program Files-->
      <Directory Id="ProgramFilesFolder" Name="PFiles">
        <Directory Id="DeltaresDir" Name="Deltares">
          <Directory Id="INSTALLDIR" Name="$(var.ProductName) $(var.FullProductVersion)">
            <Directory Id="BINDIR" Name="bin" />
            <Directory Id="PluginsFolder" Name="plugins" />
          </Directory>
        </Directory>
      </Directory>

      <!-- Start menu -->
      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Directory Id="ProgramGroupMenuDir" Name="Deltares">
          <Directory Id="ProgramMenuDir" Name="$(var.ProductName) $(var.FullProductVersion)" />
        </Directory>
      </Directory>
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="MainDirComponent" Guid="D9F6158F-98B0-4BCC-A208-AE1460EA66E0">
        <File Id="XBeachGravelManual" Name="$(var.ManualFileName)" Source='Resources\XBeachGravelManual.pdf' />
      </Component>
    </DirectoryRef>
    
    <DirectoryRef Id="BINDIR">
      <Component Id="MainExecutable" Guid="73C72B44-17A1-438D-804D-3EF1D3AA60E9">

        <File Id="icon" Name="$(var.SplashScreen)" DiskId='1' Source='Resources\$(var.SplashScreen)' />
        <File Id="License.rtf" Name="License.rtf" DiskId="1" Source="License.rtf"/>
        <File Id="WindowLayout_normal.xml" Name="WindowLayout_normal.xml" DiskId="1" Source="WindowLayout_normal.xml"/>
        <File Id="StartPageHtml" Name="$(var.StartPageHtmlName)" DiskId="1" Source="Resources\$(var.StartPageHtmlName)"/>
        <File Id="StartPageImage" Name="StartPageImage.png" DiskId="1" Source="Resources\StartPageImage.png"/>

        <util:XmlFile Id="SetKey1"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;startPageUrl&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="$(var.StartPageHtmlName)"/>

        <util:XmlFile Id="SetKey2"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;mainWindowTitle&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="$(var.Title)"/>

        <util:XmlFile Id="SetKey3"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;splashScreenLogoImageFilePath&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="$(var.SplashScreen)"/>

        <util:XmlFile Id="SetKey4"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;applicationName&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="$(var.ProductName)"/>

        <util:XmlFile Id="SetKey5"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;applicationVersion&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="$(var.FullProductVersion)"/>

        <util:XmlFile Id="SetKey6"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;fullVersion&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="$(var.FullProductVersion)"/>

        <util:XmlFile Id="SetKey7"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;shortVersion&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="$(var.ShortVersion)"/>

        <util:XmlFile Id="SetKey8"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;supportEmail&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="xbeach@deltares.nl / www.xbeach.org"/>

        <util:XmlFile Id="SetKey10"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;copyright&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="Â© Deltares 2014"/>

        <util:XmlFile Id="SetKey11"
            Action="setValue"
            ElementPath="/configuration/log4net/root/level/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="INFO"/>

        <util:XmlFile Id="SetKey12"
            Action="setValue"
            ElementPath="/configuration/appSettings/add[\[]@key=&quot;manualFileName&quot;[\]]/@value"
            File="[#DeltaShell.Gui.exe.config]"
            Value="[INSTALLDIR]\$(var.ManualFileName)"/>

        <?include ..\..\DeltaShell\MainExecutableFiles.wxi?>
	  
	  </Component>
	  
	    <?include ..\..\DeltaShell\NetCdf.wxi?>

      <!-- ! Put files/executables targeted by shortcuts in separate component ! -->
      <Component Id="DeltaShellExeAndStartMenuShortcut" Guid="*">
        <File Id='DeltaShellEXE' Name='DeltaShell.Gui.exe' DiskId='1' Source='$(var.SolutionDir)\src\DeltaShell\DeltaShell.Gui\bin\$(var.Configuration)\DeltaShell.Gui.exe' KeyPath='yes' />
        <Shortcut Id="startmenuDeltaShell" Directory="ProgramMenuDir" Name="$(var.ProductName) $(var.FullProductVersion)" WorkingDirectory='BINDIR' Icon="icon.ico" IconIndex="0" Advertise="yes" />
        <Shortcut Id="desktopDeltaShell" Directory="DesktopFolder" Name="$(var.ProductName) $(var.FullProductVersion)" WorkingDirectory='BINDIR' Icon="icon.ico" IconIndex="0" Advertise="yes" />
        
        <ProgId Id="XBeachG.Project" Description="XBeach-G project" Icon="icon.ico" IconIndex="0" Advertise="yes">
          <Extension Id="dsproj">
            <Verb Id="open" Command="Open" Argument="&quot;%1&quot;" />
            <MIME Advertise="yes" ContentType="application/dsproj" Default="yes" />
          </Extension>
        </ProgId>
        
        <RemoveFile Id="RemoveDeltaShellEXE" On="uninstall" Name="DeltaShellEXE"/>
      </Component>
      
      <Component Id="XBeachGravelManualStartMenuShortcut" Guid="*">
        <File Id='XBeachGravelManualShortcut' Name='$(var.ManualFileName)' DiskId='1' Source='Resources\XBeachGravelManual.pdf' KeyPath='yes'>
          <Shortcut Id="startmenuXBeachGravelManual" Directory="ProgramMenuDir" WorkingDirectory='INSTALLDIR' Name="$(var.ManualFileName)" Icon="pdf.ico" IconIndex="0" Advertise="yes" />
        </File>
      </Component>
      
      <?include ..\MorphAn\MorphAnDomain.wxi?>
    </DirectoryRef>

    <DirectoryRef Id="PluginsFolder">
      <!-- pass guid as variable to include project-->
      <?define PLUGIN_ID = "6701D155-775C-477F-AAE2-BE98F2DD7A07"?>
      <?include ..\..\DeltaShell\Plugins\CommonToolsPlugin.wxi?>
      <?undef PLUGIN_ID ?>

      <?define PLUGIN_ID = "2A18B7FA-C403-4DA2-9A80-9AE8B5AE60DE"?>
      <?include ..\..\DeltaShell\Plugins\CommonToolsGuiPlugin.wxi?>
      <?undef PLUGIN_ID ?>

      <?define PLUGIN_ID = "83A67C69-E7A6-4C1E-BDD2-3651DBB0C6B3"?>
      <?include ..\..\DeltaShell\Plugins\NHibernatePlugin.wxi?>
      <?undef PLUGIN_ID ?>

      <?define PLUGIN_ID ="FD682C3F-90B2-4BA6-B221-FB57E808BAFB" ?>
      <?include ..\..\DeltaShell\Plugins\NetCDFPlugin.wxi?>
      <?undef PLUGIN_ID ?>

      <?define PLUGIN_ID ="9680EDEE-7B41-4572-9621-E73C640D918E" ?>
      <?include ..\..\DeltaShell\Plugins\SharpMapGisPlugin.wxi?>
      <?undef PLUGIN_ID ?>

      <?define PLUGIN_ID = "599B78DF-FE56-4983-B0A6-3963168EFCF2"?>
      <?include ..\..\DeltaShell\Plugins\ProjectExplorerPlugin.wxi?>
      <?undef PLUGIN_ID ?>

      <?define PLUGIN_ID ="bde196ba-7164-417b-b93e-9477eada9e21" ?>
      <?define PLUGIN_ID_2 ="615b0e37-2f8a-422e-944a-285844f39e88" ?>
      <?include ..\XBeach\XBeachCommonPlugin.wxi?>
      <?undef PLUGIN_ID ?>
      <?undef PLUGIN_ID_2 ?>
      
      <?define PLUGIN_ID ="ed59a6c4-9148-4fbc-8257-0317294a21d5" ?>
      <?define PLUGIN_ID_2 ="084b3a12-4531-4913-81ea-060ba8213de6" ?>
      <?include XBeachGravelPlugin.wxi?>
      <?undef PLUGIN_ID ?>
      <?undef PLUGIN_ID_2 ?>
    </DirectoryRef>

    <DirectoryRef Id="ProgramMenuDir">
      <Component Id="ProgramMenuDir" Guid="C0B27E8B-4AB6-430C-AC13-419C9FC8CCB2">
        <Shortcut Id="UninstallProduct"
                  Name="Uninstall $(var.ProductName)"
                  Target="[System64Folder]msiexec.exe"
                  Arguments="/x [ProductCode]"
                  Description="Uninstalls $(var.ProductName)"/>
        <RemoveFolder Id="ProgramMenuDir" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]\[ProductCode]" Name="installedFolder1" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id ="ProgramGroupMenuDir">
      <Component Id="ProgramGroupMenuDir" Guid="4A4B60E2-A17E-4B0D-AA8D-BDD1096A1DB4">
        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]\[ProductCode]" Name="installedFolder0" Type="integer" Value="1" KeyPath="yes" />
        <RemoveFolder Id="ProgramGroupMenuDir" On="uninstall" />
      </Component>
    </DirectoryRef>
    
    <Feature Id="Complete" Title="$(var.Title)" Description="The complete package."
             Display="expand" Level="1" ConfigurableDirectory="INSTALLDIR">
      
      <Feature Id="DeltaShell" Title="Delta Shell" Description="Framework for plugins" Level="1" Absent="disallow" AllowAdvertise="no">
        <MergeRef Id="VCRedis10"/>
        <ComponentRef Id="MainExecutable" />
        <ComponentRef Id="MainDirComponent" />
        <ComponentRef Id="DeltaShellExeAndStartMenuShortcut"/>
        <ComponentRef Id="XBeachGravelManualStartMenuShortcut"/>
        <ComponentRef Id="ProgramGroupMenuDir"/>
        <ComponentRef Id="ProgramMenuDir" />
        <ComponentRef Id="comp_netcdf_x86" />
      </Feature>

      <Feature Id="DeltaShellPlugins" Title="Common Plugins" Description="Common plugins for Delta Shell framework" Level="1" Absent="disallow" AllowAdvertise="no" Display="hidden">
        <ComponentRef Id="CommonToolsPlugin" />
        <ComponentRef Id="CommonToolsGuiPlugin" />
        <ComponentRef Id="NHibernatePlugin" />
         <ComponentRef Id="comp_sqlite_x86" />
        <ComponentRef Id="NetCDFPlugin"/>
        <ComponentRef Id="ProjectExplorerPlugin"/>
        <ComponentRef Id="ProjectExplorerPluginResourcesNL"/>
        <ComponentRef Id="ProjectExplorerPluginResourcesRU"/>
        <ComponentRef Id="SharpMapGisPlugin"/>
      </Feature>

      <Feature Id="XBeachGravel" Title="$(var.Title)" Description ="$(var.Description)" Level="3" Absent="disallow" AllowAdvertise="no">
        <ComponentRef Id="XBeachGravelPlugin"/>
        <ComponentRef Id="XBeachGravelGuiPlugin"/>
        <ComponentRef Id="XBeachCommonPlugin"/>
        <ComponentRef Id="XBeachCommonGuiPlugin"/>
        <ComponentRef Id="XBeachDlls"/>
        <ComponentRef Id="MorphAnDomain"/>
      </Feature>

    </Feature>

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" ></Property>
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!--Note that jpg and png in setup is visible on Windows7, but not on XP and Vista-->
    <WixVariable Id="WixUIBannerBmp" Value="Resources/xbeachg_setup_banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="Resources/xbeachg_setup_start.bmp" />
        
    <WixVariable Id="WixUICostingPopupOptOut" Value="dummy" />
                     
    <UIRef Id="XBeachGravel_WixUI_Deltares" />
    <UI>
      <TextStyle Id="White8" FaceName="Tahoma" Bold="yes" Size="16" Red="0" Green="0" Blue="0"  />

      <!-- These dialog references are needed for CloseApplication above to work correctly -->

      <DialogRef Id="FilesInUseDeltares" />
      <DialogRef Id="MsiRMFilesInUseDeltares" />

    </UI>

    <UIRef Id="WixUI_ErrorProgressText" />

    <InstallExecuteSequence>
      <AppSearch Sequence="1"></AppSearch>
      <LaunchConditions After="AppSearch" />
      <!--RemoveExistingProducts After="InstallValidate"><![CDATA[PREVIOUSVERSIONSINSTALLED]]></RemoveExistingProducts-->
      <RemoveExistingProducts Before="InstallInitialize"/>
    </InstallExecuteSequence>
    
  </Product>
</Wix>
